# Dockerfile for testing Motif build on Arch Linux
FROM docker.io/archlinux:latest

LABEL maintainer="XDE Motif Development Team"
LABEL description="Arch Linux environment for testing Motif builds"
LABEL version="1.0"

# Set environment variables
ENV DEBIAN_FRONTEND=noninteractive
ENV LANG=C.UTF-8
ENV LC_ALL=C.UTF-8

# Copy dependency checker and install dependencies using make deps
COPY tools/dev/scripts/deps_check.sh /tmp/deps_check.sh
RUN chmod +x /tmp/deps_check.sh && /tmp/deps_check.sh





# Create working directory
WORKDIR /build

# Copy build script
COPY tools/dev/env/scripts/build-motif.sh /usr/local/bin/build-motif.sh
RUN chmod +x /usr/local/bin/build-motif.sh

# Set up build environment
ENV CC=gcc
ENV CXX=g++
ENV CFLAGS="-O2 -pipe -fno-plt -fexceptions -Wp,-D_FORTIFY_SOURCE=2 -Wformat -Werror=format-security -fstack-clash-protection -fcf-protection"
ENV CXXFLAGS="-O2 -pipe -fno-plt -fexceptions -Wp,-D_FORTIFY_SOURCE=2 -Wformat -Werror=format-security -fstack-clash-protection -fcf-protection"
ENV LDFLAGS="-Wl,-O1,--sort-common,--as-needed,-z,relro,-z,now"
ENV MAKEFLAGS="-j$(nproc)"

# Create non-root user for building
RUN useradd -m -s /bin/bash builder && \
    echo 'builder ALL=(ALL) NOPASSWD: ALL' >> /etc/sudoers

# Switch to builder user
USER builder
WORKDIR /home/builder

# Set entrypoint to the build script
ENTRYPOINT ["/usr/local/bin/build-motif.sh"]
