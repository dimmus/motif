# Dockerfile template for testing Motif build on ubuntu
FROM docker.io/ubuntu:22.04

LABEL maintainer="XDE Motif Development Team"
LABEL description="Ubuntu 22.04 LTS environment for testing Motif builds"
LABEL version="1.0"

# Set environment variables
ENV DEBIAN_FRONTEND=noninteractive
ENV LANG=C.UTF-8
ENV LC_ALL=C.UTF-8

# Copy dependency checker and install dependencies using make deps
COPY tools/dev/deps_check.sh /tmp/deps_check.sh
RUN chmod +x /tmp/deps_check.sh && /tmp/deps_check.sh

# Create working directory
WORKDIR /build

# Copy build script
COPY tools/dev/env/scripts/build-motif.sh /usr/local/bin/build-motif.sh
RUN chmod +x /usr/local/bin/build-motif.sh

# Set up build environment
ENV CC=gcc
ENV CXX=${CC%cc}++
ENV CFLAGS="\-O2 \-g"
ENV CXXFLAGS="\-O2 \-g"
ENV LDFLAGS=""
ENV MAKEFLAGS="-j$(nproc)"

# Create non-root user for building
RUN useradd -m -s /bin/bash builder && \
    echo 'builder ALL=(ALL) NOPASSWD: ALL' >> /etc/sudoers

# Switch to builder user
USER builder
WORKDIR /home/builder

# Default command
CMD ["/usr/local/bin/build-motif.sh"]
