# Dockerfile for testing Motif build on FreeBSD
# Note: This uses FreeBSD in a Linux container via cross-compilation setup
# For true FreeBSD testing, consider using bhyve or other virtualization
FROM docker.io/debian:bookworm-slim

LABEL maintainer="XDE Motif Development Team"
LABEL description="FreeBSD-like environment for testing Motif builds"
LABEL version="1.0"

# Set environment variables
ENV DEBIAN_FRONTEND=noninteractive
ENV LANG=C.UTF-8
ENV LC_ALL=C.UTF-8

# Copy dependency checker and install dependencies using make deps
COPY tools/dev/deps_check.sh /tmp/deps_check.sh
RUN chmod +x /tmp/deps_check.sh && /tmp/deps_check.sh

# Create working directory
WORKDIR /build

# Copy build script
COPY tools/dev/env/scripts/build-motif.sh /usr/local/bin/build-motif.sh
RUN chmod +x /usr/local/bin/build-motif.sh

# Set up FreeBSD-like build environment
ENV CC=clang
ENV CXX=clang++
ENV CPPFLAGS="-I/usr/local/include"
ENV CFLAGS="-O2 -pipe -fstack-protector-strong -fno-strict-aliasing"
ENV CXXFLAGS="-O2 -pipe -fstack-protector-strong -fno-strict-aliasing"
ENV LDFLAGS="-L/usr/local/lib -Wl,--as-needed"
ENV MAKEFLAGS="-j$(nproc)"

# FreeBSD-specific environment variables
ENV OPSYS=FreeBSD
ENV OSVERSION=1400000
ENV UNAME_s=FreeBSD
ENV UNAME_r=14.0-RELEASE
ENV UNAME_m=amd64

# Create non-root user for building
RUN useradd -m -s /bin/bash builder && \
    echo 'builder ALL=(ALL) NOPASSWD: ALL' >> /etc/sudoers

# Switch to builder user
USER builder
WORKDIR /home/builder

# Default command
CMD ["/usr/local/bin/build-motif.sh"]
