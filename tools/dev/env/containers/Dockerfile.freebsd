# Dockerfile for testing Motif build on FreeBSD
# Note: This uses FreeBSD in a Linux container via cross-compilation setup
# For true FreeBSD testing, consider using bhyve or other virtualization
FROM docker.io/debian:bookworm-slim

LABEL maintainer="XDE Motif Development Team"
LABEL description="FreeBSD-like environment for testing Motif builds"
LABEL version="1.0"

# Set environment variables
ENV DEBIAN_FRONTEND=noninteractive
ENV LANG=C.UTF-8
ENV LC_ALL=C.UTF-8

# Update system and install base tools
RUN apt-get update && apt-get install -y \
        build-essential \
        git \
        autoconf \
        automake \
        libtool \
        pkg-config \
        make \
        gcc \
        g++ \
        clang \
        llvm \
        cmake \
        ninja-build \
        gdb \
        valgrind \
        strace \
        ltrace \
        time \
        file \
        binutils \
        coreutils \
        findutils \
        grep \
        sed \
        gawk \
        tar \
        gzip \
        xz-utils \
        bzip2 \
        unzip \
        curl \
        wget \
        ca-certificates \
    && rm -rf /var/lib/apt/lists/*

# Install X11 and development libraries
RUN apt-get update && apt-get install -y \
        xorg-dev \
        libx11-dev \
        libxt-dev \
        libxmu-dev \
        libxpm-dev \
        libxext-dev \
        libxft-dev \
        libxrender-dev \
        libxrandr-dev \
        libxi-dev \
        libxinerama-dev \
        libxcursor-dev \
        libxdamage-dev \
        libxfixes-dev \
        libxcomposite-dev \
        libxss-dev \
        libxtst-dev \
        libxv-dev \
        libxxf86vm-dev \
        libxres-dev \
        libsm-dev \
        libice-dev \
        libxau-dev \
        libxdmcp-dev \
        libxcb1-dev \
        libxcb-util-dev \
        libxcb-image0-dev \
        libxcb-keysyms1-dev \
        libxcb-render-util0-dev \
        libxcb-xkb-dev \
        libxcb-icccm4-dev \
        libxcb-ewmh-dev \
    && rm -rf /var/lib/apt/lists/*

# Install additional libraries
RUN apt-get update && apt-get install -y \
        libfontconfig1-dev \
        libfreetype6-dev \
        libpng-dev \
        libjpeg62-turbo-dev \
        libtiff5-dev \
        zlib1g-dev \
        libbz2-dev \
        libexpat1-dev \
        libxml2-dev \
        libxslt1-dev \
        libssl-dev \
        libc6-dev \
        libglib2.0-dev \
        libpcre3-dev \
        libpcre2-dev \
    && rm -rf /var/lib/apt/lists/*

# Install build tools
RUN apt-get update && apt-get install -y \
        flex \
        bison \
        byacc \
        m4 \
        gettext \
        intltool \
        patch \
        diffutils \
        dos2unix \
    && rm -rf /var/lib/apt/lists/*

# Install documentation tools
RUN apt-get update && apt-get install -y \
        man-db \
        manpages-dev \
        texinfo \
        help2man \
        doxygen \
        graphviz \
    && rm -rf /var/lib/apt/lists/*

# Create working directory
WORKDIR /build

# Copy build script
COPY tools/dev/env/scripts/build-motif.sh /usr/local/bin/build-motif.sh
RUN chmod +x /usr/local/bin/build-motif.sh

# Set up FreeBSD-like build environment
ENV CC=clang
ENV CXX=clang++
ENV CPPFLAGS="-I/usr/local/include"
ENV CFLAGS="-O2 -pipe -fstack-protector-strong -fno-strict-aliasing"
ENV CXXFLAGS="-O2 -pipe -fstack-protector-strong -fno-strict-aliasing"
ENV LDFLAGS="-L/usr/local/lib -Wl,--as-needed"
ENV MAKEFLAGS="-j$(nproc)"

# FreeBSD-specific environment variables
ENV OPSYS=FreeBSD
ENV OSVERSION=1400000
ENV UNAME_s=FreeBSD
ENV UNAME_r=14.0-RELEASE
ENV UNAME_m=amd64

# Create non-root user for building
RUN useradd -m -s /bin/bash builder && \
    echo 'builder ALL=(ALL) NOPASSWD: ALL' >> /etc/sudoers

# Switch to builder user
USER builder
WORKDIR /home/builder

# Default command
CMD ["/usr/local/bin/build-motif.sh"]
