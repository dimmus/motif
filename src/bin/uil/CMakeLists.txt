# UIL common sources
set(UIL_COMMON_SRCS
    UilCmd.c
    UilDiags.c
    UilKeyTab.c
    UilLexAna.c
    UilLstLst.c
    UilP2Out.c
    UilP2Reslv.c
    UilSarComp.c
    UilSarExp.c
    UilSarInc.c
    UilSarMod.c
    UilSarObj.c
    UilSarProc.c
    UilSarVal.c
    UilSrcSrc.c
    UilSymNam.c
    UilSymStor.c
    UilData.c
    UilLstMac.c
    UilSemVal.c
    UilSemCSet.c
    UilDB.c
)

# UIL parser files are generated by WML tools
set(UIL_PARSER_C ${CMAKE_BINARY_DIR}/src/bin/wml/Uil.c)
set(UIL_PARSER_H ${CMAKE_BINARY_DIR}/src/bin/wml/Uil.h)

# UilLexPars.c is generated by the wml build process
# Create a custom command to copy it to the UIL build directory
add_custom_command(
    OUTPUT ${CMAKE_CURRENT_BINARY_DIR}/UilLexPars.c
    COMMAND ${CMAKE_COMMAND} -E copy ${CMAKE_BINARY_DIR}/src/bin/wml/UilLexPars.c ${CMAKE_CURRENT_BINARY_DIR}/UilLexPars.c
    DEPENDS ${CMAKE_BINARY_DIR}/src/bin/wml/UilLexPars.c
    COMMENT "Copying UilLexPars.c for UIL build"
)

# Add the copied file to sources
set(UIL_LEXPARS_C ${CMAKE_CURRENT_BINARY_DIR}/UilLexPars.c)
list(APPEND UIL_COMMON_SRCS ${UIL_LEXPARS_C})

# Generate message catalog header file
if(WITH_MESSAGE_CATALOG)
    add_custom_command(
        OUTPUT ${CMAKE_BINARY_DIR}/include/uil/UilMsgCatI.h
        COMMAND ${CMAKE_COMMAND} -E make_directory ${CMAKE_BINARY_DIR}/include/uil
        COMMAND ${CMAKE_BINARY_DIR}/src/bin/utils/mkcatdefs
            ${CMAKE_BINARY_DIR}/include/uil/UilMsgCatI.h
            ${CMAKE_SOURCE_DIR}/src/bin/uil/Uil.msg
            > /dev/null 2>&1
        DEPENDS ${CMAKE_BINARY_DIR}/src/bin/utils/mkcatdefs ${CMAKE_SOURCE_DIR}/src/bin/uil/Uil.msg
        COMMENT "Generating Uil message catalog header"
    )
else()
    add_custom_command(
        OUTPUT ${CMAKE_BINARY_DIR}/include/uil/UilMsgCatI.h
        COMMAND ${CMAKE_COMMAND} -E make_directory ${CMAKE_BINARY_DIR}/include/uil
        COMMAND ${CMAKE_COMMAND} -E echo "/* UilMsgCatI.h - Generated stub */" > ${CMAKE_BINARY_DIR}/include/uil/UilMsgCatI.h
        COMMAND ${CMAKE_COMMAND} -E echo "#ifndef _UilMsgCatI_h" >> ${CMAKE_BINARY_DIR}/include/uil/UilMsgCatI.h
        COMMAND ${CMAKE_COMMAND} -E echo "#define _UilMsgCatI_h" >> ${CMAKE_BINARY_DIR}/include/uil/UilMsgCatI.h
        COMMAND ${CMAKE_COMMAND} -E echo "#endif /* _UilMsgCatI_h */" >> ${CMAKE_BINARY_DIR}/include/uil/UilMsgCatI.h
        COMMENT "Creating Uil message catalog stub"
    )
endif()

# Create a custom target for the message catalog header
add_custom_target(uil_msgcat_header ALL DEPENDS ${CMAKE_BINARY_DIR}/include/uil/UilMsgCatI.h)

# Create libUil library
add_library(Uil ${UIL_COMMON_SRCS})

# Ensure message catalog header is generated before building this target
add_dependencies(Uil uil_msgcat_header)

# Ensure all UIL files are generated before building UIL
add_dependencies(Uil wml_generated_files uil_parser_target)

target_include_directories(Uil PRIVATE
    ${CMAKE_SOURCE_DIR}/include
    ${CMAKE_SOURCE_DIR}/src/lib
    ${CMAKE_SOURCE_DIR}/src/bin/wml
    ${CMAKE_BINARY_DIR}/include
    ${CMAKE_BINARY_DIR}/include/uil
    ${CMAKE_BINARY_DIR}/lib
    ${CMAKE_BINARY_DIR}/src/bin/wml
    ${X_INCLUDE_DIRS}
)

target_compile_definitions(Uil PRIVATE
    INCDIR="${CMAKE_INSTALL_INCLUDEDIR}/X11"
    LIBDIR="${CMAKE_INSTALL_LIBDIR}/X11"
)

if(ENABLE_UIL_DEBUG)
    target_compile_definitions(Uil PRIVATE XM_UIL_DEBUG)
endif()

target_link_libraries(Uil
    Mrm
    Xm
    ${X_LIBRARIES}
    m
    pthread
)

# Add system includes
target_compile_options(Uil PRIVATE
    -include ${CMAKE_SOURCE_DIR}/include/motif_system.h
)

# Create uil executable
add_executable(uil ${UIL_COMMON_SRCS} UilMain.c)

# Ensure message catalog header is generated before building this target
add_dependencies(uil uil_msgcat_header uil_parser_target)

target_include_directories(uil PRIVATE
    ${CMAKE_SOURCE_DIR}/include
    ${CMAKE_SOURCE_DIR}/src/lib
    ${CMAKE_SOURCE_DIR}/src/bin/wml
    ${CMAKE_BINARY_DIR}/include
    ${CMAKE_BINARY_DIR}/include/uil
    ${CMAKE_BINARY_DIR}/lib
    ${CMAKE_BINARY_DIR}/src/bin/wml
    ${X_INCLUDE_DIRS}
)

target_compile_definitions(uil PRIVATE
    INCDIR="${CMAKE_INSTALL_INCLUDEDIR}/X11"
    LIBDIR="${CMAKE_INSTALL_LIBDIR}/X11"
)

if(ENABLE_UIL_DEBUG)
    target_compile_definitions(uil PRIVATE XM_UIL_DEBUG)
endif()

target_link_libraries(uil
    Mrm
    Xm
    ${X_LIBRARIES}
    m
    pthread
)

# Add system includes
target_compile_options(uil PRIVATE
    -include ${CMAKE_SOURCE_DIR}/include/motif_system.h
)

# Install executables and libraries
install(TARGETS uil Uil
    RUNTIME DESTINATION ${CMAKE_INSTALL_BINDIR}
    LIBRARY DESTINATION ${CMAKE_INSTALL_LIBDIR}
    ARCHIVE DESTINATION ${CMAKE_INSTALL_LIBDIR}
)

# Install headers
install(FILES
    Uil.h
    UilSymGl.h
    UilSymDef.h
    UilDef.h
    XmAppl.uil
    DESTINATION ${CMAKE_INSTALL_INCLUDEDIR}/uil
)
